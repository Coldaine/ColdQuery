name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]
    paths:
      - 'coldquery/**'
      - 'Dockerfile'
      - 'docker-compose.deploy.yml'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy on Raspberry Pi
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.PI_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync code to Pi
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude 'legacy' \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ "${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/opt/coldquery/"

      - name: Build and Deploy on Raspberry Pi
        run: |
          ssh -i ~/.ssh/id_ed25519 "${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}" bash -s << 'EOF'
            set -e
            cd /opt/coldquery

            echo "=== Creating .env file ==="
            cat > .env << ENVEOF
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          TS_AUTHKEY=${{ secrets.TAILSCALE_AUTH_KEY }}
          ENVEOF

            echo "=== Building Docker image locally (native ARM64) ==="
            docker build -t coldquery:latest .

            echo "=== Stopping old containers ==="
            docker compose -f docker-compose.deploy.yml down --remove-orphans 2>/dev/null || true

            echo "=== Starting new containers ==="
            docker compose -f docker-compose.deploy.yml up -d

            echo "=== Waiting for health check ==="
            for i in $(seq 1 30); do
              if docker container inspect coldquery-server --format '{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
                echo "Deployment successful and container is healthy!"
                exit 0
              fi
              echo "Attempt $i/30: waiting for container to become healthy..."
              sleep 5
            done

            echo "=== Health check failed, showing logs ==="
            docker logs coldquery-server --tail 50
            exit 1
          EOF
