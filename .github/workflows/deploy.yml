name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]
    paths:
      - 'coldquery/**'
      - 'Dockerfile.deps'
      - 'docker-compose.deploy.yml'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Raspberry Pi
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.PI_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync code to Pi
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude '.venv' \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ "${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/opt/coldquery/"

      - name: Deploy on Raspberry Pi
        run: |
          ssh -i ~/.ssh/id_ed25519 "${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}" bash -s << 'EOF'
            set -e
            cd /opt/coldquery

            echo "=== Creating .env file ==="
            cat > .env << ENVEOF
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          ENVEOF

            echo "=== Checking if deps image needs rebuild ==="
            if ! docker image inspect coldquery-deps:latest >/dev/null 2>&1; then
              echo "Building deps image (first time)..."
              docker build -f Dockerfile.deps -t coldquery-deps:latest .
            fi

            echo "=== Restarting container (code is mounted) ==="
            docker compose -f docker-compose.deploy.yml up -d --force-recreate

            echo "=== Waiting for health check ==="
            for i in $(seq 1 30); do
              if docker container inspect coldquery-server --format '{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
                echo "Deployment successful!"
                exit 0
              fi
              echo "Attempt $i/30: waiting for container to become healthy..."
              sleep 5
            done

            echo "=== Health check failed, showing logs ==="
            docker logs coldquery-server --tail 50
            exit 1
          EOF

      - name: Rebuild deps if pyproject.toml changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "pyproject.toml"; then
            echo "pyproject.toml changed, rebuilding deps image..."
            ssh -i ~/.ssh/id_ed25519 "${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}" bash -s << 'EOF'
              cd /opt/coldquery
              docker build -f Dockerfile.deps -t coldquery-deps:latest .
              docker compose -f docker-compose.deploy.yml up -d --force-recreate
          EOF
          else
            echo "No dependency changes, skipping deps rebuild"
          fi
